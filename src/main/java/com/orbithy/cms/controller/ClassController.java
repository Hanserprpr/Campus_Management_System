package com.orbithy.cms.controller;

import com.orbithy.cms.annotation.Auth;
import com.orbithy.cms.data.dto.CreateCourseDTO;
import com.orbithy.cms.data.vo.Result;
import com.orbithy.cms.service.ClassService;
import com.orbithy.cms.utils.ResponseUtil;
import jakarta.annotation.Resource;
import jakarta.servlet.http.HttpServletRequest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/class")
public class ClassController {
    @Resource
    private ClassService classService;
    @Autowired
    private HttpServletRequest request;

    /**
     * 教师创建课程
     *
     * @param courseDTO 课程信息
     * @return ResponseEntity<Result>
     */
    @Auth
    @PostMapping("/create")
    public ResponseEntity<Result> createCourse(@RequestBody CreateCourseDTO courseDTO) {
        String userId = request.getHeader("userId");
        return classService.createCourse(userId, courseDTO);
    }

    /**
     * 教务审批课程
     *
     * @param courseId 课程ID
     * @param status 审批状态（1通过，2拒绝）
     * @param classNum 课序号（通过时必填）
     * @param reason 拒绝理由（拒绝时必填）
     * @return ResponseEntity<Result>
     */
    @Auth
    @PostMapping("/approve/{courseId}")
    public ResponseEntity<Result> approveCourse(@PathVariable Integer courseId,
                                              @RequestParam Integer status,
                                              @RequestParam(required = false) String classNum,
                                              @RequestParam(required = false) String reason) {
        String userId = request.getHeader("userId");
        return classService.approveCourse(userId, courseId, status, classNum, reason);
    }

    /**
     * 获取课程列表
     * 支持按学期筛选
     *
     * @param term 学期（可选，格式：YYYY-YYYY-S，例如：2023-2024-1）
     * @return ResponseEntity<Result>
     */
    @Auth
    @GetMapping("/list")
    public ResponseEntity<Result> getCourseList(@RequestParam(required = false) String term) {
        String userId = request.getHeader("userId");
        return classService.getCourseList(userId, term);
    }

    /**
     * 获取课程详情
     *
     * @param courseId 课程ID
     * @return ResponseEntity<Result>
     */
    @Auth
    @GetMapping("/detail/{courseId}")
    public ResponseEntity<Result> getCourseDetail(@PathVariable Integer courseId) {
        String userId = request.getHeader("userId");
        return classService.getCourseDetail(userId, courseId);
    }

    /**
     * 教师修改课程信息
     *
     * @param courseId 课程ID
     * @param courseDTO 课程信息
     * @return ResponseEntity<Result>
     */
    @Auth
    @PostMapping("/update/{courseId}")
    public ResponseEntity<Result> updateCourse(@PathVariable Integer courseId,
                                             @RequestBody CreateCourseDTO courseDTO) {
        String userId = request.getHeader("userId");
        return classService.updateCourse(userId, courseId, courseDTO);
    }

    /**
     * 教师删除课程
     *
     * @param courseId 课程ID
     * @return ResponseEntity<Result>
     */
    @Auth
    @PostMapping("/delete/{courseId}")
    public ResponseEntity<Result> deleteCourse(@PathVariable Integer courseId) {
        String userId = request.getHeader("userId");
        return classService.deleteCourse(userId, courseId);
    }

    /**
     * 获取待批准的课程列表
     */
    @Auth
    @GetMapping("/pending")
    public ResponseEntity<Result> getPendingCourses() {
        String userId = request.getHeader("userId");
        return classService.getPendingCourses(userId);
    }
}
